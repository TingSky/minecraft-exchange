# 修复浮窗表单提交后处理的实施计划

## 1. 分析浮窗结构

项目中包含以下浮窗：

| 浮窗名称 | 页面 | 浮窗ID | 表单ID | 提交URL |
|----------|------|--------|--------|---------|
| 创建任务模板 | admin.html | createTaskModal | createTaskForm | /create_task |
| 创建/编辑物品 | admin.html | new-item-modal | item-form | /create_item 或 /update_item |

## 2. 实施步骤

### 2.1 修改AJAX处理函数

修改`static/js/main.js`中的`ajaxFormSubmit`函数，在成功回调中：

1. 检查表单是否在浮窗中
2. 如果是，关闭浮窗
3. 重置表单
4. 刷新对应模块的数据

### 2.2 为浮窗和模块添加标识

为浮窗和对应模块添加特定的类或ID，以便在AJAX成功后识别：

1. 为创建任务模板浮窗添加标识
2. 为任务模板列表模块添加标识
3. 为创建/编辑物品浮窗添加标识
4. 为物品列表模块添加标识

### 2.3 添加局部刷新功能

为每个模块添加局部刷新功能，使用fetch API重新获取数据，然后更新DOM：

1. 添加刷新任务模板列表的函数
2. 添加刷新物品列表的函数
3. 添加刷新任务列表的函数
4. 添加刷新兑换记录列表的函数

### 2.4 使用Playwright MCP测试

使用Playwright MCP测试所有修改内容，确保：

1. 浮窗在提交后关闭
2. 表单重置
3. 对应模块刷新
4. 所有功能正常工作

## 3. 预期效果

1. **创建任务模板**：
   - 填写表单，点击"创建任务"
   - 浮窗关闭
   - 表单重置
   - 任务模板列表刷新

2. **创建物品**：
   - 填写表单，点击"创建物品"
   - 浮窗关闭
   - 表单重置
   - 物品列表刷新

3. **编辑物品**：
   - 填写表单，点击"更新物品"
   - 浮窗关闭
   - 表单重置
   - 物品列表刷新

## 4. 技术细节

1. **修改AJAX处理函数**：
   ```javascript
   // 在ajaxFormSubmit函数的successCallback中添加
   if (form.closest('.modal')) {
       // 关闭浮窗
       const modal = form.closest('.modal');
       modal.style.display = 'none';
       // 重置表单
       form.reset();
   }
   // 刷新对应模块
   refreshCorrespondingModule(form);
   ```

2. **添加局部刷新函数**：
   ```javascript
   // 刷新任务模板列表
   function refreshTaskTemplates() {
       fetch('/admin')
           .then(response => response.text())
           .then(html => {
               // 解析HTML，提取任务模板列表
               const parser = new DOMParser();
               const doc = parser.parseFromString(html, 'text/html');
               const newList = doc.querySelector('.task-templates-list');
               const oldList = document.querySelector('.task-templates-list');
               if (newList && oldList) {
                   oldList.innerHTML = newList.innerHTML;
               }
           });
   }
   ```

3. **使用Playwright MCP测试**：
   ```javascript
   // 测试创建任务模板
   await page.fill('#task-title', '测试任务');
   await page.fill('#task-description', '测试描述');
   await page.selectOption('#task-difficulty', 'easy');
   await page.selectOption('#task-type', 'daily');
   await page.fill('#task-reward', '10');
   await page.click('#createTaskForm button[type="submit"]');
   
   // 验证浮窗关闭
   await expect(page.locator('#createTaskModal')).not.toBeVisible();
   
   // 验证表单重置
   await expect(page.locator('#task-title')).toHaveValue('');
   
   // 验证任务模板列表刷新
   await expect(page.locator('.task-templates-list')).toContainText('测试任务');
   ```

## 5. 实施顺序

1. 修改AJAX处理函数，添加浮窗关闭和表单重置功能
2. 为浮窗和模块添加标识
3. 添加局部刷新功能
4. 使用Playwright MCP测试所有修改内容

这个计划将确保浮窗在提交后关闭，表单重置，对应模块刷新，提供更好的用户体验。